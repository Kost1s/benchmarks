#!/usr/bin/env bash
##
## Copyright 2015-2021 Real Logic Limited.
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
## https://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##

function await_process_start()
{
  local pid=${1}
  echo "pid=${pid}; while [ -z \"\${pid}\" ]; do sleep 0.5; pid=${pid}; done; echo \"pid=\${pid}\""
}

function find_java_process()
{
  local class_name=${1}
  echo "\$(pgrep -l -f '${class_name}' | awk '/java/{print \$1}')"
}

function await_java_process_start()
{
  local class_name=${1}
  await_process_start "$(find_java_process "${class_name}")"
}

function pin_thread()
{
  local pid=${1}
  local thread_name=${2}
  local core=${3}
  local tid="\$(ps Ho tid,comm -p ${pid} | awk '/${thread_name}/{print \$1}')"
  echo "tid=${tid}; while [ -z \"\${tid}\" ]; do sleep 0.1; tid=${tid}; done; echo \"tid_${thread_name}=\${tid}\"; taskset -p -c ${core} \${tid}"
}

function kill_java_process()
{
  local class_name=${1}
  echo "kill -9 $(find_java_process "${class_name}")"
}
